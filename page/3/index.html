<!DOCTYPE html>




<html class="theme-next mist" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="Kane Xie">
<meta property="og:url" content="http://kane-xie.github.io/page/3/index.html">
<meta property="og:site_name" content="Kane Xie">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kane Xie">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://kane-xie.github.io/page/3/">





  <title>Kane Xie</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Kane Xie</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kane-xie.github.io/2017/07/23/2017-07-23_实时计算平台架构/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kane Xie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kane Xie">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/23/2017-07-23_实时计算平台架构/" itemprop="url">实时计算平台架构</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-23T00:00:00+08:00">
                2017-07-23
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/23/2017-07-23_实时计算平台架构/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/07/23/2017-07-23_实时计算平台架构/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/attachment/rt-platform/01.PNG" alt=""></p>
<p><img src="/attachment/rt-platform/02.PNG" alt=""></p>
<p><img src="/attachment/rt-platform/03.PNG" alt=""></p>
<p><img src="/attachment/rt-platform/04.PNG" alt=""></p>
<p><img src="/attachment/rt-platform/05.PNG" alt=""></p>
<p><img src="/attachment/rt-platform/06.PNG" alt=""></p>
<p><img src="/attachment/rt-platform/07.PNG" alt=""></p>
<p><img src="/attachment/rt-platform/08.PNG" alt=""></p>
<p><img src="/attachment/rt-platform/09.PNG" alt=""></p>
<p><img src="/attachment/rt-platform/10.PNG" alt=""></p>
<p><img src="/attachment/rt-platform/11.PNG" alt=""></p>
<p><img src="/attachment/rt-platform/12.PNG" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kane-xie.github.io/2017/07/22/2017-07-22_Kafka Streams自动创建内部topic/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kane Xie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kane Xie">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/22/2017-07-22_Kafka Streams自动创建内部topic/" itemprop="url">Kafka Streams自动创建内部topic</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-22T00:00:00+08:00">
                2017-07-22
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/22/2017-07-22_Kafka Streams自动创建内部topic/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/07/22/2017-07-22_Kafka Streams自动创建内部topic/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>运行一段kafka streams程序的时候，报出以下异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Properties settings = <span class="keyword">new</span> Properties();</span><br><span class="line">settings.put(StreamsConfig.APPLICATION_ID_CONFIG, <span class="string">"my-first-streams-application"</span>);</span><br><span class="line">settings.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"10.128.74.83:9092"</span>);</span><br><span class="line">StreamsConfig config = <span class="keyword">new</span> StreamsConfig(settings);</span><br><span class="line"></span><br><span class="line">TopologyBuilder builder = <span class="keyword">new</span> TopologyBuilder();</span><br><span class="line">builder.addSource(<span class="string">"SOURCE"</span>, <span class="string">"source_topic"</span>).addProcessor(<span class="string">"PROCESS1"</span>, MyProcessor::<span class="keyword">new</span>, <span class="string">"SOURCE"</span>)</span><br><span class="line">        .addStateStore(Stores.create(<span class="string">"COUNTS"</span>).withStringKeys().withIntegerValues().inMemory().build(),</span><br><span class="line">                <span class="string">"PROCESS1"</span>)</span><br><span class="line">        .addSink(<span class="string">"SINK3"</span>, <span class="string">"sink_topic"</span>, <span class="string">"PROCESS1"</span>);</span><br><span class="line">KafkaStreams streams = <span class="keyword">new</span> KafkaStreams(builder, config);</span><br><span class="line">streams.start();</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;StreamThread-1&quot; org.apache.kafka.streams.errors.StreamsException: stream-thread [StreamThread-1] Failed to rebalance</span><br><span class="line">    at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:410)</span><br><span class="line">    at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:242)</span><br><span class="line">Caused by: org.apache.kafka.streams.errors.StreamsException: task [0_0] Could not find partition info for topic: my-first-streams-application1-COUNTS1-changelog</span><br><span class="line">    at org.apache.kafka.streams.processor.internals.ProcessorStateManager.register(ProcessorStateManager.java:174)</span><br><span class="line">    ……</span><br></pre></td></tr></table></figure>
<p>从异常信息上看是topic:my-first-streams-application1-COUNTS1-changelog不存在。这个topic是kafka streams的内部topic，用于保存state store的changelog。topic的命名格式是：&lt;application.id&gt;-<operatorname>-<suffix>，这些内部topic应该会在kafka streams应用执行的时候被自动创建，但为什么这里会报topic找不到呢？</suffix></operatorname></p>
<p>联想到用kafka-topics.sh是需要传入zookeeper地址的，因为topic的metadata会保存在zk中，那么kafka streams也应该在配置中指定zk地址才能创建topic，加上以下配置之后程序就能跑起来了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">settings.put(StreamsConfig.ZOOKEEPER_CONNECT_CONFIG, <span class="string">"10.128.74.83:2181"</span>);</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kane-xie.github.io/2017/07/12/2017-07-12_Flink使用lambda表达式/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kane Xie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kane Xie">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/12/2017-07-12_Flink使用lambda表达式/" itemprop="url">Flink使用lambda表达式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-12T00:00:00+08:00">
                2017-07-12
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/12/2017-07-12_Flink使用lambda表达式/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/07/12/2017-07-12_Flink使用lambda表达式/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Java8出来之后，lambda表达式由于简单易读，在流式计算中的使用开始变得普遍。</p>
<p>同样,Flink也支持lambda表达式，例如我们改写一下wordcount样例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DataSource&lt;String&gt; lines = env.fromElements(</span><br><span class="line">    <span class="string">"Apache Flink is a community-driven open source framework for distributed big data analytics,"</span>,</span><br><span class="line">    <span class="string">"like Hadoop and Spark. The core of Apache Flink is a distributed streaming dataflow engine written"</span>,</span><br><span class="line">            ...</span><br><span class="line">);</span><br><span class="line">lines.flatMap(<span class="keyword">new</span> FlatMapFunction&lt;String, Object&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flatMap</span><span class="params">(String line, Collector&lt; Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (String word : line.split(<span class="string">"\\W+"</span>)) &#123;</span><br><span class="line">            out.collect(<span class="keyword">new</span> Tuple2&lt;&gt;(word, <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).groupBy(<span class="number">0</span>).sum(<span class="number">1</span>).print();</span><br></pre></td></tr></table></figure>
<p>这段代码很简单，先把每一行按空格拆分成若干单词，并将每个单词和数字1组成一个Tuple，然后把所有Tuple按照单词聚合，计算出每个单词的出现次数</p>
<p>尝试用lambda表达式来替换FlatMapFunction，代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">lines.flatMap((line, out) -&gt; &#123;</span><br><span class="line">    <span class="keyword">for</span> (String word : line.split(<span class="string">"\\W+"</span>)) &#123;</span><br><span class="line">        out.collect(<span class="keyword">new</span> Tuple2&lt;&gt;(word, <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).groupBy(<span class="number">0</span>).sum(<span class="number">1</span>).print();</span><br></pre></td></tr></table></figure>
<p>但当运行这段代码时，会抛出如下异常：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Caused by: org.apache.flink.api.common.functions.InvalidTypesException: The generic type parameters of &apos;Collector&apos; are missing. </span><br><span class="line">It seems that your compiler has not stored them into the .class file. </span><br><span class="line">Currently, only the Eclipse JDT compiler preserves the type information necessary to use the lambdas feature type-safely. </span><br><span class="line">See the documentation for more information about how to compile jobs containing lambda expressions.</span><br><span class="line">    at org.apache.flink.api.java.typeutils.TypeExtractor.validateLambdaGenericParameter(TypeExtractor.java:1653)</span><br><span class="line">    at org.apache.flink.api.java.typeutils.TypeExtractor.validateLambdaGenericParameters(TypeExtractor.java:1639)</span><br><span class="line">    at org.apache.flink.api.java.typeutils.TypeExtractor.getUnaryOperatorReturnType(TypeExtractor.java:573)</span><br><span class="line">    at org.apache.flink.api.java.typeutils.TypeExtractor.getFlatMapReturnTypes(TypeExtractor.java:188)</span><br><span class="line">    at org.apache.flink.api.java.DataSet.flatMap(DataSet.java:266)</span><br><span class="line">    at TestFlink.main(TestFlink.java:21)</span><br></pre></td></tr></table></figure></p>
<p>这是因为Flink在用户自定义的函数中会使用泛型来创建serializer，当我们使用匿名函数时，类型信息会被保留。但Lambda表达式并不是匿名函数，所以javac编译的时候并不会把泛型保存到class文件里。</p>
<p>解决办法有两种:</p>
<p>第一种办法在异常中已经提示，使用Eclipse JDT编译器会保留对lambda表达式来说必要的类型信息。在Maven中使用Eclipse JDT编译器，只需要在把下面的插件加入到pom.xml中<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">compilerId</span>&gt;</span>jdt<span class="tag">&lt;/<span class="name">compilerId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.eclipse.tycho<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tycho-compiler-jdt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.21.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>另一种办法是，使用Flink提供的returns方法来指定flatMap的返回类型，<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">text.flatMap((line, out) -&gt; &#123;</span><br><span class="line">    <span class="keyword">for</span> (String word : line.split(<span class="string">"\\W+"</span>)) &#123;</span><br><span class="line">        out.collect(<span class="keyword">new</span> Tuple2&lt;&gt;(word, <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).returns((TypeInformation) TupleTypeInfo.getBasicTupleTypeInfo(String.class, Integer.class)).groupBy(<span class="number">0</span>).sum(<span class="number">1</span>)</span><br><span class="line">        .print();</span><br></pre></td></tr></table></figure></p>
<p>returns函数接收TypeInformation类型的参数，这里我们创建TupleTypeInfo来指定Tuple的参数类型。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kane-xie.github.io/2016/10/09/2016-10-09_Failed to allocate memory within the configured max blocking time/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kane Xie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kane Xie">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/09/2016-10-09_Failed to allocate memory within the configured max blocking time/" itemprop="url">Failed to allocate memory within the configured max blocking time</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-09T00:00:00+08:00">
                2016-10-09
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/10/09/2016-10-09_Failed to allocate memory within the configured max blocking time/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/09/2016-10-09_Failed to allocate memory within the configured max blocking time/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Kafka版本0.9.0.1，发送数据时报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Failed to allocate memory within the configured max blocking time</span><br></pre></td></tr></table></figure></p>
<p>原因很明显，如果producer端缓存（buffer.memory，默认32M）满了的话，在一定时间（max.block.ms，默认60s）内如果数据无法被放入缓存，则抛出该异常。</p>
<p>发生该异常之后，producer的性能急剧下降，TPS从10000+降低到50.</p>
<p>经过分析，原因是在尝试把数据放入缓存之前（Buffer.allocate），会在Condition队列waiters中插入一条新记录，<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Condition moreMemory = <span class="keyword">this</span>.lock.newCondition();</span><br><span class="line"><span class="keyword">this</span>.waiters.addLast(moreMemory);</span><br></pre></td></tr></table></figure></p>
<p>如果一定时间内没有能放到缓存中，则直接抛出异常，moreMemory并没有从waiters中移除。</p>
<p>而producer的缓存刷新的逻辑（RecordAccumulator.ready）如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> exhausted = <span class="keyword">this</span>.free.queued() &gt; <span class="number">0</span>;</span><br><span class="line">……</span><br><span class="line"><span class="keyword">boolean</span> sendable = full || expired || exhausted || closed || flushInProgress();</span><br></pre></td></tr></table></figure></p>
<p>其中free.queued() 的返回值就是waiters.size()，因此如果抛出本文开头所说的异常，那么之后每发一条数据，sendable都会为true，所以每发一条数据都会刷新一次缓存，相当于是同步发送，效率非常差。</p>
<p>好在在0.10中已经修复了这个bug，在抛出异常之前，先调用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.waiters.remove(moreMemory);</span><br></pre></td></tr></table></figure></p>
<p>JIRA</p>
<blockquote>
<p><a href="https://issues.apache.org/jira/browse/KAFKA-3651" target="_blank" rel="noopener">https://issues.apache.org/jira/browse/KAFKA-3651</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kane-xie.github.io/2016/10/01/2016-10-01_Kafka收发oversize数据/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kane Xie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kane Xie">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/01/2016-10-01_Kafka收发oversize数据/" itemprop="url">Kafka收发oversize数据</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-01T00:00:00+08:00">
                2016-10-01
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/10/01/2016-10-01_Kafka收发oversize数据/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/01/2016-10-01_Kafka收发oversize数据/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Kafka整个消息管道的默认口径是1M，换句话说，默认Producer只能向Kafka发送大小不超过1M的消息，Kafka内部也只能处理大小不超过1M的消息，Consumer也只能消费大小不超过1M的消息。</p>
<p>如果发送2M（为了方便计算，以下1M=1000K）大小的数据，client会报异常</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.util.concurrent.ExecutionException: org.apache.kafka.common.errors.RecordTooLargeException: The message is 2000037 bytes when serialized which is larger than the maximum request size you have configured with the max.request.size configuration.</span><br></pre></td></tr></table></figure>
<p>根据提示，在Producer config中设置max.request.size为2M+（注意必须大于2M，因为消息本身的metadata也会占用空间，比如上文日志中，一条包含2M数据的消息的大小是2M+37 byte），但服务器返回异常</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.util.concurrent.ExecutionException: org.apache.kafka.common.errors.RecordTooLargeException: The request included a message larger than the max message size the server will accept.</span><br></pre></td></tr></table></figure>
<p>服务器无法接收这么大的消息。那么修改Kafka的server.properties，添加message.max.bytes=2M，然后重启Kafka集群。发送成功。</p>
<p>然后尝试消费消息，报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; org.apache.kafka.common.errors.RecordTooLargeException: There are some messages at [Partition=Offset]: &#123;test-1=6863354&#125; whose size is larger than the fetch size 1048576 and hence cannot be ever returned. Increase the fetch size on the client (using max.partition.fetch.bytes), or decrease the maximum message size the broker will allow (using message.max.bytes).</span><br></pre></td></tr></table></figure>
<p>根据提示，在Consumer config中设置max.partition.fetch.bytes为2M。消费成功。</p>
<p>但还没完，这时发现Kafka的bytes_out异常的高，几乎逼近带宽极限，但这时并没有客户端在往Kafka里发送数据，查看Kafka日志，发现有异常</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[2016-10-25 03:15:08,361] ERROR [ReplicaFetcherThread-0-1], Replication is failing due to a message that is greater than replica.fetch.max.bytes for partition [test,1]. This generally occurs when the max.message.bytes has been overridden to exceed this value and a suitably large message has also been sent. To fix this problem increase replica.fetch.max.bytes in your broker config to be equal or larger than your settings for max.message.bytes, both at a broker and topic level. (kafka.server.ReplicaFetcherThread)</span><br></pre></td></tr></table></figure>
<p>原因是修改message.max.bytes之后，Kafka broker已经能接收2M的数据，但replication fetcher尝试备份时失败了，因为replica.fetch.max.bytes控制了最大的备份消息size是1M。由于replication fetcher会无限的重试备份，因此bytes_out会急剧升高。把replica.fetch.max.bytes设置成2M，并重启broker之后，问题解决。</p>
<p>由于可以通过topic-level参数max.message.bytes来控制每个topic所能接收的最大消息size，所以为了避免重启，可以将replica.fetch.max.bytes设置为一个比较大的值（比如10M），以后如果有某个topic需要收发oversize的消息，只需要修改该topic的max.message.bytes就行，不需要重启集群。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kane-xie.github.io/2016/09/24/2016-09-24_Elasticsearch Plugins/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kane Xie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kane Xie">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/24/2016-09-24_Elasticsearch Plugins/" itemprop="url">Elasticsearch Plugins</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-09-24T00:00:00+08:00">
                2016-09-24
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/09/24/2016-09-24_Elasticsearch Plugins/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/24/2016-09-24_Elasticsearch Plugins/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>安利几个ES的插件：</p>
<p>sql<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GITHUB地址：https://github.com/NLPchina/elasticsearch-sql/blob/master/README.md?utm_source=tuicool&amp;utm_medium=referral</span><br><span class="line">在线安装：./bin/plugin -u https://github.com/NLPchina/elasticsearch-sql/releases/download/&#123;version&#125;/elasticsearch-sql-&#123;version&#125;.zip --install sql</span><br><span class="line">访问地址：http://localhost:9200/_plugin/sql/</span><br></pre></td></tr></table></figure></p>
<p>kopf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GITHUB地址：https://github.com/lmenezes/elasticsearch-kopf/</span><br><span class="line">在线安装：./bin/plugin install lmenezes/elasticsearch-kopf/&#123;branch|version&#125;</span><br><span class="line">访问地址：http://localhost:9200/_plugin/kopf/</span><br></pre></td></tr></table></figure></p>
<p>HQ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GITHUB地址：https://github.com/royrusso/elasticsearch-HQ#version-compatibility</span><br><span class="line">在线安装：./bin/plugin install royrusso/elasticsearch-HQ/&#123;version&#125;</span><br><span class="line">访问地址：http://localhost:9200/_plugin/HQ/</span><br></pre></td></tr></table></figure></p>
<p>head<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GITHUB地址：https://github.com/mobz/elasticsearch-head</span><br><span class="line">在线安装：./bin/plugin -install mobz/elasticsearch-head/&#123;version&#125;</span><br><span class="line">访问地址：http://localhost:9200/_plugin/head/</span><br></pre></td></tr></table></figure></p>
<p>安装这几个插件需要注意一下版本，如果插件版本和ES版本不适配的话是不能正常工作的，版本对应关系请参照相应插件的GITHUB。</p>
<p>如果你对于ES的查询不是很熟悉，或者对ES复杂的查询语句感到厌烦，sql插件对你肯定是个福音。除了WEB-UI之外，你也可以直接将它用在Simple Query中：<code>http://localhost:9200/_sql?sql=select * from indexName limit 10</code></p>
<p>另外3个插件kopf，head和HQ的功能都大同小异，都是ES的监控和一些常用操作的封装。个人感觉head更偏向于数据搜索，kopf界面比较专业，但HQ的功能感觉更全面强大一些，个人推荐HQ。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kane-xie.github.io/2016/09/21/2016-09-21_ShutdownHook没有移除导致内存泄漏/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kane Xie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kane Xie">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/21/2016-09-21_ShutdownHook没有移除导致内存泄漏/" itemprop="url">ShutdownHook没有移除导致内存泄漏</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-09-21T00:00:00+08:00">
                2016-09-21
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/09/21/2016-09-21_ShutdownHook没有移除导致内存泄漏/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/21/2016-09-21_ShutdownHook没有移除导致内存泄漏/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天做kafka高并发测试的时候发生内存泄漏，直接原因是producer关闭之后内存没有得到释放。根本原因是：</p>
<ul>
<li><p>为了确保线程producer的connection断开，在线程里加了ShutdownHook</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addShutdownHook</span><span class="params">(<span class="keyword">final</span> Closeable closeable, <span class="keyword">final</span> Boolean isClosed)</span> </span>&#123;</span><br><span class="line">	Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread() &#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (!isClosed.booleanValue()) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					closeable.close();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在producer close之后，由于ShutdownHook里保存着producer的句柄（closeable），导致producer的内存没有办法被JVM回收，线程多了之后，导致OOM</p>
</li>
<li><p>解决办法是，在producer.close()之后，调用<code>Runtime.getRuntime().removeShutdownHook(shutdownHook);</code></p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kane-xie.github.io/2016/09/07/2016-09-07_Cloudera Manager配置/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kane Xie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kane Xie">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/07/2016-09-07_Cloudera Manager配置/" itemprop="url">Cloudera Manager配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-09-07T00:00:00+08:00">
                2016-09-07
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/09/07/2016-09-07_Cloudera Manager配置/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/07/2016-09-07_Cloudera Manager配置/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>登录<code>http://&lt;cm-server&gt;:7180/cmf/login</code>，用户名/密码：admin/admin。由于cm-server的启动需要花点时间，这里可能要等待一会才能访问。</li>
</ul>
<p><img src="/attachment/cm-confifure/Picture1.png" alt=""></p>
<ul>
<li>选择Cloudera Express版本</li>
</ul>
<p><img src="/attachment/cm-confifure/Picture2.png" alt=""></p>
<ul>
<li>在Currently Manage Hosts中选择所有节点</li>
</ul>
<p><img src="/attachment/cm-confifure/Picture3.png" alt=""></p>
<ul>
<li>用Parcels安装，并选择合适的版本</li>
</ul>
<p><img src="/attachment/cm-confifure/Picture4.png" alt=""></p>
<ul>
<li>由于我们已经下载了parcel并放到parcel-repo中，所以下载步骤很快就完成了。但分发，解压和激活还是需要一些时间</li>
</ul>
<p><img src="/attachment/cm-confifure/Picture5.png" alt=""></p>
<ul>
<li>机器检测，正常情况应该都是绿勾</li>
</ul>
<p><img src="/attachment/cm-confifure/Picture6.png" alt=""></p>
<ul>
<li>选择需要安装的服务</li>
</ul>
<p><img src="/attachment/cm-confifure/Picture7.png" alt=""></p>
<ul>
<li>选择服务的集群分布，系统默认把所有的管理功能（比如hdfs namenode，hbase master等）放在cm-server，所有的slaves（datanode，region server等）功能放在其他cm-agent。“select hosts”表示暂不安装，未安装的服务可以以后随时安装</li>
</ul>
<p><img src="/attachment/cm-confifure/Picture8.png" alt=""></p>
<ul>
<li>初始化数据库。建议为每种服务创建一个数据库</li>
</ul>
<p><img src="/attachment/cm-confifure/Picture9.png" alt=""></p>
<ul>
<li>修改配置。一般不需要修改</li>
</ul>
<p><img src="/attachment/cm-confifure/Picture10.png" alt=""></p>
<ul>
<li>集群初始化和启动，需要花一些时间</li>
</ul>
<p><img src="/attachment/cm-confifure/Picture11.png" alt=""></p>
<ul>
<li>安装结束</li>
</ul>
<p><a href="http://www.cloudera.com/documentation/enterprise/latest/topics/cm_mc_managing_services.html" target="_blank" rel="noopener">管理服务</a></p>
<p><a href="http://www.cloudera.com/documentation/enterprise/latest/topics/cdh_hag_hdfs_ha_config.html" target="_blank" rel="noopener">配置HDFS HA</a></p>
<p><a href="http://www.cloudera.com/documentation/enterprise/latest/topics/cm_sg_intro_kerb.html" target="_blank" rel="noopener">配置Authentication</a></p>
<p><a href="http://www.cloudera.com/documentation/enterprise/latest/topics/sg_sentry_overview.html" target="_blank" rel="noopener">配置Autorization(sentry)</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kane-xie.github.io/2016/09/07/2016-09-07_Cloudera Manager安装/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kane Xie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kane Xie">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/07/2016-09-07_Cloudera Manager安装/" itemprop="url">Cloudera Manager安装</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-09-07T00:00:00+08:00">
                2016-09-07
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/09/07/2016-09-07_Cloudera Manager安装/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/07/2016-09-07_Cloudera Manager安装/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>准备一台虚拟机作为cm-server</li>
<li><p>配置ssh免密码登录，在cm-server上执行脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">CLUSTER_NODES=localhost</span><br><span class="line"><span class="comment">#replace ',' with space</span></span><br><span class="line">CLUSTER_NODES=<span class="variable">$&#123;CLUSTER_NODES//,/ &#125;</span></span><br><span class="line"></span><br><span class="line">FILE=~/.ssh/id_rsa.pub</span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">"<span class="variable">$&#123;FILE&#125;</span>"</span> ]; <span class="keyword">then</span> </span><br><span class="line">    ssh-keygen -t rsa -P <span class="string">''</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$CLUSTER_NODES</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	scp ~/.ssh/id_rsa.pub root@<span class="variable">$&#123;i&#125;</span>:/tmp</span><br><span class="line">	ssh root@<span class="variable">$&#123;i&#125;</span> <span class="string">"cat /tmp/id_rsa.pub &gt;&gt; /root/.ssh/authorized_keys"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装jdk</p>
<ul>
<li>创建链接，mkdir /usr/java;ln -s ${JAVA_HOME} /usr/java/default</li>
</ul>
</li>
<li><p>安装perl</p>
<ul>
<li>下载perl-5.16.2.tar.gz到cm-server上</li>
<li>解压</li>
<li>cd perl-5.16.2</li>
<li>./Configure -des -Dprefix=/usr/local/perl -Dusethreads -Uversiononly</li>
<li>make</li>
<li>make install</li>
</ul>
</li>
<li><p>安装cloudera manager</p>
<ul>
<li>下载<a href="https://archive.cloudera.com/cm5/cm/5/" target="_blank" rel="noopener">cloudera-manager-centos7-cm5.8.0_x86_64.tar.gz</a>到cm-server上</li>
<li>解压到/opt目录下，tar -zxvf cloudera-manager-centos7-cm5.8.0_x86_64.tar.gz –C /opt</li>
<li>修改/opt/cm-5.8.0/etc/cloudera-scm-agent/config.ini的server_host为cm-server的ip地址</li>
</ul>
</li>
<li><p>创建cm用户</p>
<ul>
<li>useradd –system –home=/opt/cm-5.8.0/run/cloudera-scm-server –no-create-home –shell=/bin/false –comment “Cloudera SCM User” cloudera-scm</li>
</ul>
</li>
<li><p>修改/etc/hosts，配置所有cm节点的IP和hostname，包括cm-server和cm-agent</p>
</li>
<li><p>其他系统配置</p>
<ul>
<li><p>关闭防火墙</p>
<p>  service iptables stop （临时关闭） </p>
<p> chkconfig iptables off （重启后永久生效）</p>
</li>
<li><p>关闭SELinux</p>
<p> setenforce 0 （临时生效）  </p>
<p> 修改 /etc/selinux/config下的 SELINUX=disabled （重启后永久生效）</p>
</li>
<li><p>修改/etc/sysctl.conf，在最后一行加上：vm.swappiness=0</p>
</li>
<li>修改/etc/rc.local，在最后一行加上：echo never &gt; /sys/kernel/mm/transparent_hugepage/defrag</li>
<li>重启cm-server</li>
</ul>
</li>
<li><p>克隆虚拟机cm-server，到所有cm agent节点</p>
</li>
<li><p>在cm-server上安装mysql</p>
</li>
<li><p>创建并配置数据库</p>
<ul>
<li>create database &lt;data_name&gt; DEFAULT CHARSET utf8 COLLATE utf8_general_ci;</li>
<li>需要创建的数据库有:cm,hive,sentry,oozie,hue</li>
<li><p>root授权访问以上所有的数据库: </p>
<p> grant all on *.* to root@’%’;</p>
<p> grant all privileges on *.* to root@’%’ identified by ‘admin’;</p>
</li>
</ul>
</li>
<li><p>拷贝JDBC驱动mysql-connector-java-5.1.39-bin.jar到cdh: /opt/cm-5.8.0/share/cmf/lib</p>
</li>
<li>初始化cm数据库：<ul>
<li>sh /opt/cm-5.8.0/share/cmf/schema/scm_prepare_database.sh mysql cm <username> <password></password></username></li>
</ul>
</li>
<li>准备parcels，用于安装CDH，下载<a href="http://archive.cloudera.com/cdh5/parcels/5.8/" target="_blank" rel="noopener">parcels</a>到cm-server: /opt/cloudera/parcel-repo，注意把.sha1文件的后缀改为.sha，且最好用sha1sum命令确认文件没有在下载中损坏</li>
<li>拷贝JDBC驱动mysql-connector-java-5.1.39-bin.jar到/opt/cloudera/parcels/CDH/lib/hive/lib和/var/lib/oozie</li>
<li>启动cm-server，sh /opt/cm-5.8.0/etc/init.d/cloudera-scm-server start</li>
<li>启动每个cm-agent，sh /opt/cm-5.8.0/etc/init.d/cloudera-scm-agent start</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kane-xie.github.io/2016/08/25/2016-08-25_影响单次poll返回最大数据量的几个因素/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kane Xie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kane Xie">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/25/2016-08-25_影响单次poll返回最大数据量的几个因素/" itemprop="url">影响单次poll返回最大数据量的几个因素</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-25T00:00:00+08:00">
                2016-08-25
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/08/25/2016-08-25_影响单次poll返回最大数据量的几个因素/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/25/2016-08-25_影响单次poll返回最大数据量的几个因素/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div class="note info"><h2>timeout</h2></div>

<p>单次poll最大等待时间，consumer.poll(1000)意味着在缓存中的数据被消费完之后，consumer会到broker中拉取数据，最多等待1000毫秒。很明显，timeout越大，单次poll返回的数据就越多。但前提是有足够多的数据可供消费，如果在1000毫秒内，consumer已经拿完所有能拿的数据，就会立即返回。</p>
<div class="note info"><h2>max.poll.records</h2></div>

<p>单次poll最大返回数据条数，默认值2,147,483,647。这应该不需要解释。</p>
<div class="note info"><h2>receive.buffer.bytes</h2></div>

<p>用于TCP读取数据的缓存（SO_RCVBUF）大小，默认值64k。之前做过小测试，发现消费10万条大小1k的数据，花费5秒左右，设置max.poll.records=1，理论上来说性能应该大大下降才对，但实际测试结果也在5秒左右。后来发现消费端有64k缓存，换句话说每次TCP请求会拿64条数据，因此虽然poll每次只拿一条数据，但也是从缓存中拿，拿64次才会真正发送一次TCP请求。而相对于1k大小数据的消费，TCP请求的开销可以忽略，因此消费时间差不多。当测试数据大小为1个字节时，TCP请求的开销就不能忽略了，而测试结果也证实，max.poll.records=1会使消费性能下降2/3。</p>
<div class="note info"><h2>max.partition.fetch.bytes</h2></div>

<p>单次poll对于每个partition最大返回数据量，默认值1M。如果消费的topic有3个partition，那么单次poll最多返回3M数据。但实际上发现单次poll一般都只返回1M的数据，而不是3M。检查数据的分布，也都分散在3个partition中。原因是consumer会启动3个fetcher分别到每个partition抓取数据，而考虑到性能问题，consumer会在fetch一个partition一定时间后才会fetch下一个partition，所以单次poll很可能只是在拿一个partition中的数据，所以返回1M数据。把测试时间延长之后发现，偶尔会有一次poll拿到2M数据，符合刚才的分析。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Kane Xie</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">72</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">28</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kane Xie</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"your-duoshuo-shortname"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  


















  





  

  

  

  
  

  

  

  

</body>
</html>
