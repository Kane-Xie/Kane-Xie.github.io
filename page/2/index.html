<!DOCTYPE html>




<html class="theme-next mist" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="不吃早餐才是一件很嘻哈的事">
<meta property="og:type" content="website">
<meta property="og:title" content="Kane Xie">
<meta property="og:url" content="http://kane-xie.github.io/page/2/index.html">
<meta property="og:site_name" content="Kane Xie">
<meta property="og:description" content="不吃早餐才是一件很嘻哈的事">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kane Xie">
<meta name="twitter:description" content="不吃早餐才是一件很嘻哈的事">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://kane-xie.github.io/page/2/">





  <title>Kane Xie</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Kane Xie</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kane-xie.github.io/2017/12/15/2017-12-15_HBase1.2 java client使用心得/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kane Xie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/attachment/hexo/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kane Xie">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/15/2017-12-15_HBase1.2 java client使用心得/" itemprop="url">HBase1.2 java client使用心得</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-15T00:00:00+08:00">
                2017-12-15
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/12/15/2017-12-15_HBase1.2 java client使用心得/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/12/15/2017-12-15_HBase1.2 java client使用心得/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/12/15/2017-12-15_HBase1.2 java client使用心得/" class="leancloud_visitors" data-flag-title="HBase1.2 java client使用心得">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近对HBase做了升级，从0.92升级到了1.2.0-cdh5.11.1，版本跨度很大，而且从社区版转向了Cloudera。之所以改用CDH，是因为大概两年前在前一个公司做HBase CDH4到CDH5的升级，由于一开始搭建集群的时候就没用Cloudera Manager，所以导致升级非常痛苦，因为两个版本之间底层文件的格式变了，所以为了稳定，找了另外一批机器装了CDH5，然后实现源数据的双写，再用export+import把CDH4的数据全量导过去，最后稳定并行一段时间之后把CDH4停掉。整个流程听着就很麻烦，开销也很大（相当于资源*2），所以这次选择了先把0.92平移到CDH4，然后用Cloudera Manager升级，整个过程非常平滑</p>
<p>升级之后（准确说是升级之前就需要准备）发现HBase client的API已经有了很大的变动，所以也花了一些时间来研究，以下是一些心得</p>
<ul>
<li><p>有些旧的类和函数已经被废弃或将要被废弃，尽量使用新的API，比如：</p>
<ul>
<li>使用ConnectionFactory管理Connection</li>
<li>用Table替代HTable，用Connection替代HConnection，Admin替代HBaseAdmin等等</li>
<li>使用工厂类而不是原生的构造函数来生成类</li>
<li>获取table改用参数TableName，而不是之前的String或者byte[]</li>
</ul>
</li>
<li><p>Table的使用</p>
</li>
</ul>
<p>以前的使用方式<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Configuration conf = HBaseConfiguration.create();</span><br><span class="line">HTable t = <span class="keyword">new</span> HTable(conf, <span class="string">"mytable"</span>);</span><br><span class="line">t.put(<span class="keyword">new</span> Put(row).add(fam, qual, value));</span><br><span class="line">t.close();</span><br></pre></td></tr></table></figure></p>
<p>现在的使用方式<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Configuration conf = HBaseConfiguration.create();</span><br><span class="line">Connection conn = ConnectionFactory.createConnection(conf)</span><br><span class="line">Table t = conn.getTable(TableName.valueOf(<span class="string">"mytable"</span>));</span><br><span class="line">t.put(<span class="keyword">new</span> Put(row).add(fam, qual, value));</span><br><span class="line">t.close();</span><br><span class="line">conn.close;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>无论是Connection, Table, Admin还是Scanner，用完就关，由于这些接口或多或少的都在client端或server端(Scanner)hold住了一些资源，所以对于性能来讲，及时关掉是非常必要的。另外，由于这些接口都继承了Closeable，所以使用Java的try语法能否非常容易的close掉，而在之前的版本需要在try之外声明，然后在finally中关闭，还要加上null check</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (Connection connection = ConnectionFactory.createConnection(conf);        </span><br><span class="line">     Admin admin = connection.getAdmin();</span><br><span class="line">     Table table = connection.getTable(tableName);) &#123;</span><br><span class="line">  	 table.get(<span class="keyword">new</span> Get(...))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Connection是线程安全且非常重的对象，因为它包含了zookeeper的连接，socket连接等等，所以最好在一个应用中只创建一个Connection供多线程使用，并且在整个程序退出之前才关闭。与Connection相反，Table，Admin等都是相对比较轻量的组件，并且<code>非</code>线程安全，所以可以针对每个请求创建一个单独的实例，请求处理完就关闭</p>
</li>
<li><p>使用BufferedMutator实现批量/流式Puts，它替代了之前版本的手动flush，提供了高性能的流式写入</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kane-xie.github.io/2017/12/08/2017-12-08_Flume数据截断问题/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kane Xie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/attachment/hexo/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kane Xie">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/08/2017-12-08_Flume数据截断问题/" itemprop="url">Flume数据截断问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-08T00:00:00+08:00">
                2017-12-08
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/12/08/2017-12-08_Flume数据截断问题/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/12/08/2017-12-08_Flume数据截断问题/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/12/08/2017-12-08_Flume数据截断问题/" class="leancloud_visitors" data-flag-title="Flume数据截断问题">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><div class="note info"><h2>问题</h2></div><br>发送到SyslogUDPSource的单个请求数据大小超过2k的话会被截断，即只保留2k，其他数据丢失</p>
<p><div class="note info"><h2>原因</h2></div><br>SyslogUDPSource使用AdaptiveReceiveBufferSizePredictorFactory来处理buffer，理想的状况是buffer size会随着数据大小扩容，最大64k，但实际并没有。因为AdaptiveReceiveBufferSizePredictorFactory只针对NioDatagramWorker起作用，但SyslogUDPSource使用OioDatagramChannelFactory，buffer size永远是2k，超过就截断</p>
<p><div class="note info"><h2>解决办法</h2></div><br>改用FixedReceiveBufferSizePredictorFactory，固定大小64k，解决</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kane-xie.github.io/2017/11/01/2017-11-01_ES Rollover Index/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kane Xie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/attachment/hexo/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kane Xie">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/01/2017-11-01_ES Rollover Index/" itemprop="url">ES Rollover Index</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-01T00:00:00+08:00">
                2017-11-01
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/11/01/2017-11-01_ES Rollover Index/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/11/01/2017-11-01_ES Rollover Index/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/11/01/2017-11-01_ES Rollover Index/" class="leancloud_visitors" data-flag-title="ES Rollover Index">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Elasticsearch的TTL已经在5.0之后废除，它的原理是定时标记过期数据，然后从index中删除并执行merge，这个操作的开销是很大的，这就是TTL被废除的原因。作为替代，5.0之后加入了Rollover API，我们可以基于这个功能在某种程度上实现TTL语法</p>
<p>Rollover API的原理与之前一篇文章<a href="http://kane-xie.github.io/pages/2017-09-24_0.html">实时场景中Elasticsearch冷热索引分离</a>中提到了<code>index拆分</code>是一样的，即当index的大小或者有效期（当前时间-创建时间）超过一定阈值时，滚动创建一个新的index</p>
<p>Rollover API接受一个<code>alias name</code>和一个<code>conditions</code>列表作为参数。参数中的alias必须指向且只指向一个index。当index满足参数中指定的conditions中的任意一个时，ES会创建一个新的index并且将alias转而指向它，这里借用一张老图</p>
<p><img src="/attachment/20170924/es_alias.png" alt="alias"></p>
<div class="note info"><h2>基本语法</h2></div>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 创建一个名为logs-0000001的index，并赋予别名logs_write</span><br><span class="line">PUT /logs-000001 </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"aliases"</span>: &#123;</span><br><span class="line">    <span class="attr">"logs_write"</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 当logs_write指向的index创建时间超过7天，或者documents大于等于1000个，或者包含的数据size超过5GB，则会创建一个新的index logs-0000002并将logs_write指向它，同时移除旧的index logs-0000001的别名</span><br><span class="line">POST /logs_write/_rollover </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"conditions"</span>: &#123;</span><br><span class="line">    <span class="attr">"max_age"</span>:   <span class="string">"7d"</span>,</span><br><span class="line">    <span class="attr">"max_docs"</span>:  <span class="number">1000</span>,</span><br><span class="line">    <span class="attr">"max_size"</span>:  <span class="string">"5gb"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Response如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"acknowledged"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"shards_acknowledged"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"old_index"</span>: <span class="string">"logs-000001"</span>,</span><br><span class="line">  <span class="attr">"new_index"</span>: <span class="string">"logs-000002"</span>,</span><br><span class="line">  <span class="attr">"rolled_over"</span>: <span class="literal">true</span>, </span><br><span class="line">  <span class="attr">"dry_run"</span>: <span class="literal">false</span>, </span><br><span class="line">  <span class="attr">"conditions"</span>: &#123; </span><br><span class="line">    <span class="attr">"[max_age: 7d]"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"[max_docs: 1000]"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"[max_size: 5gb]"</span>: <span class="literal">false</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>rolled_over</code>：index是否被滚动创建，即滚动条件是否满足<br><code>dry_run</code>：是否是测试演练，即不真正执行<br><code>conditions</code>：每个condition是否满足</p>
<div class="note info"><h2>命名新index</h2></div>

<p>如果旧的index以<code>-{number}</code>结尾，比如<code>logs-1</code>，那么新的index将会沿袭旧的格式，并将结尾的number加1并自动填充0以保持数字长度为6，例如<code>logs-000002</code>，如果旧的index名字不以<code>-{number}</code>结尾，那么必须手动指定新的index名字</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST /my_alias/_rollover/my_new_index_name</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"conditions"</span>: &#123;</span><br><span class="line">    <span class="attr">"max_age"</span>:   <span class="string">"7d"</span>,</span><br><span class="line">    <span class="attr">"max_docs"</span>:  <span class="number">1000</span>,</span><br><span class="line">    <span class="attr">"max_size"</span>: <span class="string">"5gb"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果希望按日期来滚动生成并且命名index，那么可以使用ES提供的<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.2/date-math-index-names.html" target="_blank" rel="noopener">date math</a>。Rollover API支持date math，但要求index必须以<code>.{number}</code>结尾，例如<code>logstash-2016.02.03-1</code>，无论日期是否相同，最后数字总会在滚动之后+1</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># 创建index并以当天日期命名，例如logs-2017.11.01-1</span><br><span class="line">PUT /%3Clogs-%7Bnow%2Fd%7D-1%3E </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"aliases"</span>: &#123;</span><br><span class="line">    <span class="attr">"logs_write"</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 写入一条记录</span><br><span class="line">PUT logs_write/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"message"</span>: <span class="string">"a dummy log"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># refresh以使该条记录立即生效</span><br><span class="line">POST logs_write/_refresh</span><br><span class="line"></span><br><span class="line"># 如果在当天执行以下请求，则滚动生成的新的index名称为logs-2017.11.01-000002，但如果是在第二天执行，则新的index名为logs-2017.11.02-000002</span><br><span class="line">POST /logs_write/_rollover </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"conditions"</span>: &#123;</span><br><span class="line">    <span class="attr">"max_docs"</span>:   <span class="string">"1"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note info"><h2>定义新index</h2></div>

<p>我觉得按常理的话，滚动生成的新的index应该继承旧的index的mappings和settings，但实际上并不是，如果不指定的话，新的index会用ES默认的配置。当然你可以使用<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.2/indices-templates.html" target="_blank" rel="noopener">index templates</a>或者在请求体中自定义配置，就和<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.2/indices-create-index.html" target="_blank" rel="noopener">create index API</a>一样</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">PUT /logs-000001</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"aliases"</span>: &#123;</span><br><span class="line">    <span class="attr">"logs_write"</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 指定新的index的shards为2</span><br><span class="line">POST /logs_write/_rollover</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"conditions"</span> : &#123;</span><br><span class="line">    <span class="attr">"max_age"</span>: <span class="string">"7d"</span>,</span><br><span class="line">    <span class="attr">"max_docs"</span>: <span class="number">1000</span>,</span><br><span class="line">    <span class="attr">"max_size"</span>: <span class="string">"5gb"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"index.number_of_shards"</span>: <span class="number">2</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note info"><h2>调试</h2></div>

<p>Rollover API支持<code>dry_run</code>模式，即只是检查条件是否满足，但并不真正执行新建index和重定向alias的操作</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PUT /logs-000001</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"aliases"</span>: &#123;</span><br><span class="line">    <span class="attr">"logs_write"</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /logs_write/_rollover?dry_run</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"conditions"</span> : &#123;</span><br><span class="line">    <span class="attr">"max_age"</span>: <span class="string">"7d"</span>,</span><br><span class="line">    <span class="attr">"max_docs"</span>: <span class="number">1000</span>,</span><br><span class="line">    <span class="attr">"max_size"</span>: <span class="string">"5gb"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kane-xie.github.io/2017/10/13/2017-10-13_xms和xmx是否必须设置相等/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kane Xie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/attachment/hexo/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kane Xie">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/13/2017-10-13_xms和xmx是否必须设置相等/" itemprop="url">xms和xmx是否必须设置相等</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-13T00:00:00+08:00">
                2017-10-13
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/10/13/2017-10-13_xms和xmx是否必须设置相等/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/10/13/2017-10-13_xms和xmx是否必须设置相等/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/10/13/2017-10-13_xms和xmx是否必须设置相等/" class="leancloud_visitors" data-flag-title="xms和xmx是否必须设置相等">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近申请了几台机器专门用来运行Kafka Streams应用，发现经常发生OOM导致应用挂掉，原因是启动的时候指定了<code>-Xms2G -Xmx2G</code>，所以16G内存的机器没启几个应用内存就被占满了，尽管这些程序只是空跑。查了一下一般都建议-Xms和-Xmx设置为相等，那么能不能设置为不一样呢？</p>
<p>先了解一下-Xms和-Xmx的含义</p>
<div class="note info"><h2>-Xms</h2></div>

<p>初始堆的大小，也是堆大小的最小值，默认值是总共的物理内存/64（且小于1G），默认情况下，当堆中可用内存小于40%（这个值可以用-XX: MinHeapFreeRatio 调整，如-X:MinHeapFreeRatio=30）时，堆内存会开始增加，一直增加到-Xmx的大小</p>
<div class="note info"><h2>-Xmx</h2></div><br>堆的最大值，默认值是总共的物理内存1/4，如果Xms和Xmx都不设置，则两者大小会相同，默认情况下，当堆中可用内存大于70%（这个值可以用-XX: MaxHeapFreeRatio 调整，如-X:MaxHeapFreeRatio=60）时，堆内存会开始减少，一直减小到-Xms的大小<br><br>可以通过以下命令查看系统默认的InitialHeapSize和MaxHeapSize：<br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -XX:+PrintFlagsFinal -version | grep HeapSize</span><br></pre></td></tr></table></figure><br><br><div class="note info"><h2>-Xms=-Xmx？</h2></div>

<p>如果设定一个比较小的初始堆大小，并且程序需要的内存大于-Xms时，JVM将会分配更多的堆内存，且有可能需要移动一些objects和记账（book-keeping），这些动作都比较耗时，会使程序响应变慢，极端情况下甚至会导致OOM。假如程序在闲时和忙时的负载差别比较大，堆内存就会不停的伸缩。如果设置-Xms=-Xmx就不会有这样的问题</p>
<p>但是在测试环境或者开发环境中，Kafka并不会一直有数据（至少我的这个测试环境是这样，非UA），所以大部分时间Kafka Streams程序都是在空跑，所以堆内存会长期处于-Xms的状态。这种情况下设置-Xms=-Xmx是极大的浪费</p>
<div class="note info"><h2>结论</h2></div>

<p>在生产环境，设置-Xms和-Xmx相等以保证程序稳定。在开发测试环境，设置一个比较小的-Xms，以支撑更多的测试程序运行</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kane-xie.github.io/2017/09/30/2017-09-30_Missing artifact jdk.tools/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kane Xie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/attachment/hexo/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kane Xie">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/30/2017-09-30_Missing artifact jdk.tools/" itemprop="url">Missing artifact jdk.tools：jdk.tools：jar：1.6</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-30T00:00:00+08:00">
                2017-09-30
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/09/30/2017-09-30_Missing artifact jdk.tools/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/09/30/2017-09-30_Missing artifact jdk.tools/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/09/30/2017-09-30_Missing artifact jdk.tools/" class="leancloud_visitors" data-flag-title="Missing artifact jdk.tools：jdk.tools：jar：1.6">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Maven错误信息：Missing artifact jdk.tools:jdk.tools:jar:1.6  </p>
<p>最近发现只要在Maven项目中引入HBase依赖，就会报错<code>Missing artifact jdk.tools:jdk.tools:jar:1.6</code></p>
<p>在网上搜，基本都是说引入jdk.tools依赖就行，比如<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>jdk.tools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jdk.tools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>system<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">systemPath</span>&gt;</span>$&#123;JAVA_HOME&#125;/lib/tools.jar<span class="tag">&lt;/<span class="name">systemPath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>但这个办法治标不治本啊，为什么会jdk.tools找不到呢？比较诡异的是，同事用IDEA就没问题，所以我怀疑问题出在Eclipse上（我老人家还是习惯用Eclipse。。。）</p>
<p>经过排查发现启动Eclipse使用的JRE（默认在C:\Program Files下）没有tools.jar，这个依赖包是JDK里的JRE才有的，所以需要在Eclipse配置文件（ECLIPSE_HOME/eclipse.ini）里指定启动JRE<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-vm</span><br><span class="line">C:\Program Files\Java\jdk1.8.0_151\jre\bin\server\jvm.dll</span><br></pre></td></tr></table></figure></p>
<p>注意：-vm后面一定要换行，并且这两行配置一定要在<code>-vmargs</code>前面</p>
<p>然后Maven -&gt; Update Project（Alt+F5）就可以了</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kane-xie.github.io/2017/09/24/2017-09-24_实时场景中Elasticsearch冷热索引分离/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kane Xie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/attachment/hexo/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kane Xie">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/24/2017-09-24_实时场景中Elasticsearch冷热索引分离/" itemprop="url">实时场景中Elasticsearch冷热索引分离</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-24T00:00:00+08:00">
                2017-09-24
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/09/24/2017-09-24_实时场景中Elasticsearch冷热索引分离/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/09/24/2017-09-24_实时场景中Elasticsearch冷热索引分离/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/09/24/2017-09-24_实时场景中Elasticsearch冷热索引分离/" class="leancloud_visitors" data-flag-title="实时场景中Elasticsearch冷热索引分离">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>如果你的ES集群的每台机器性能有比较大的差距，比如其中几台机器有SSD而其他机器用的普通磁盘，或者部分机器内存比较大，并且低配机器已经拖累了整个集群的读写性能，那么你需要考虑把写入频率和搜索频率比较高的热索引放到高性能的机器上，以获得更高的读写效率，同时把冷索引移到性能较差的机器上，以做到物尽其用</p>
<p><div class="note info"><h2>node分组</h2></div><br>首先我们需要根据所在机器性能的高低给node(这里专指data node)分组，这样我们在分离索引的时候才能知道热索引应该移到哪些高性能节点上去。这可以在启动时通过给每个节点设置属性来实现。例如我们有一台高性能机器，那么在这台机器上启动ES时我们可以通过以下方式声明它是“高性能的”<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/elasticsearch -Enode.attr.performance=high</span><br></pre></td></tr></table></figure></p>
<p>或者在elasticsearch.yml中配置<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">node.attr.performance=high</span></span><br></pre></td></tr></table></figure></p>
<p>但是注意，这里的声明仅仅只是声明了一个属性键值对“performance=high”了，相当于给节点逻辑上做了分组，但并没有任何实际的作用，你甚至可以声明“a=b”，但为了可维护性考虑，最好还是起有意义的名称</p>
<p>类似的，我们在另外一台低性能的机器上启动ES时声明它是“低性能的”<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/elasticsearch -Enode.attr.performance=low</span><br></pre></td></tr></table></figure></p>
<p><div class="note info"><h2>冷热分离</h2></div><br>然后可以通过维护index的settings<code>index.routing.allocation.*</code>来控制该索引分配到指定的“组”中，即移动到该组相应的节点上。例如我们把index1移动到高性能的机器上，把index2移动到低性能的机器上<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT index1/_settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"index.routing.allocation.include.performance"</span>: <span class="string">"high"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT index2/_settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"index.routing.allocation.include.performance"</span>: <span class="string">"low"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样就做到了冷热索引的分离，今后无论是集群伸缩还是增减备份数，该索引的所有shards（包括replica）都只会被分配在指定的组内，这里要注意，如果任一组内所有的节点都down掉，则绑定在该组节点的index都会处于unassigned状态</p>
<p>另一个要考虑的问题是如何定义冷热索引。个人建议是先按照QPS将所有index排序，先将大部分QPS较高的index甚至所有index放到高性能组里，然后从QPS最低的index开始一个个移到低性能组里，直到两组index的读写性能基本均衡</p>
<p><div class="note info"><h2>index拆分</h2></div><br>通常我们认为冷索引是指那些不再新增或更新的数据，但在实时场景中，index一般都会持续更新，那么所有的index都是热索引，就没法做分离了。这种情况下我们就需要先做index拆分，具体做法是每隔一定时间，比如每天新建一个index，归为热索引，旧的index一般就不会再有更新，归为冷索引</p>
<p>这里有一个问题，新建的index是不能与原来重名的，所以我们加个时间后缀用于区分，例如test_index_20170924。但这个做法会带来一个新的麻烦，index的名称每天都在变，所以每次都需要以日期作为后缀才能找到当前的热索引</p>
<p>用别名可以解决这个问题</p>
<p><img src="/attachment/20170924/es_alias.png" alt="alias"></p>
<p>我们给这个这个index起一个别名叫test_alias，指向当日的index，比如test_index_20170924，第二天创建了一个新的index: test_index_20170925，然后把test_alias跟test_index_20170924的关联解除，然后把test_alias指向test_index_20170925。这样我们如果要读写当前热索引，只需要访问test_alias就可以了，从ES用户的角度来看，感觉不到index做了拆分<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /_aliases</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"actions"</span> : [</span><br><span class="line">        &#123; <span class="attr">"remove"</span> : &#123; <span class="attr">"index"</span> : <span class="string">"test_index_20170924"</span>, <span class="attr">"alias"</span> : <span class="string">"test_alias"</span> &#125; &#125;,</span><br><span class="line">        &#123; <span class="attr">"add"</span>:  &#123; <span class="attr">"index"</span>: <span class="string">"test_index_20170925"</span>, <span class="attr">"alias"</span>: <span class="string">"test_alias"</span> &#125; &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意这里remove和add两个动作一定要放在一个transaction里完成，否则如果先remove再add，可能会导致alias短暂不可用，如果先add再remove，可能会导致有短暂时间写入异常，因为alias同时指向两个index，ES无法决定应该写入哪一个</p>
<p>热索引读写的问题解决了，但还是有一些搜索的问题需要考虑，一个是全文搜索，用通配符是可以的，比如test_index_*，但如果刚好有其他index的前缀也是test_index_就麻烦了，可以通过新建一个别名指向所有的index来解决。还有就是幂等性无法保证的问题，如果你需要用id来保证幂等性，并且无法保证相同id的数据会在同一天写入，那么这个冷热索引分离的方案是行不通的，因为即使id在旧的index里存在，但在新的index里找不到，只能当做一条新数据插入</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kane-xie.github.io/2017/09/09/2017-09-09_Elasticsearch写入速度优化/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kane Xie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/attachment/hexo/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kane Xie">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/09/2017-09-09_Elasticsearch写入速度优化/" itemprop="url">Elasticsearch写入速度优化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-09T00:00:00+08:00">
                2017-09-09
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/09/09/2017-09-09_Elasticsearch写入速度优化/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/09/09/2017-09-09_Elasticsearch写入速度优化/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/09/09/2017-09-09_Elasticsearch写入速度优化/" class="leancloud_visitors" data-flag-title="Elasticsearch写入速度优化">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div class="note info"><h2>批量操作</h2></div>

<p>批量写入比单条写入能够提供更好的性能。BulkProcessor可以通过三个阈值控制批量大小，分别是数据条数，数据size和时间间隔。通常来讲更大的批量会带来更好的性能，但也并不尽然，如果单个批次数据量过大，高并发的情况下会导致集群内存压力增大，官方建议是不要一次发送几十兆的数据，从我测试的结果来看，这个说法过于乐观，建议不超过5M</p>
<p><div class="note info"><h2>多线程</h2></div><br>单线程批量发送数据无法达到最大效率。使用多线程或者多进程能够更充分地利用集群资源，同时也能减少fsync的开销，因为数据的集中发送可以减少磁盘交互</p>
<p>但要注意响应码TOO_MANY_REQUESTS (429)，在Java Client中会返回EsRejectedExecutionException异常，这说明数据总发送速度已经超过了ES集群的处理能力，这时就需要发送端限流，比如加入时间补偿机制。或者也可以调大ES的bulk queue size，通常并不建议这么做，但某些版本的bulk queue size确实过于小，比如5.1的默认值是50,而5.5是200，所以如果你使用的是5.1版本，则可以在elasticsearch.yml加入以下配置<code>thread_pool.bulk.queue_size: 200</code></p>
<p><div class="note info"><h2>增大refresh interval</h2></div><br>默认的index.refresh_interval是1秒，使用默认配置的index会每隔一秒钟创建一个新的segment，这会给ES带来比较大的merge压力，因此如果对延迟没有特别高的要求，可以适当调大index.refresh_interval，比如10秒</p>
<p><div class="note info"><h2>离线批量导入时关闭refresh和replica</h2></div><br>如果你需要一次性从外部系统导入数据到ES，你可以通过设置index.refresh_interval为-1来关掉refresh，设置index.number_of_replicas为0来去掉备份，这样可以大大提升数据的导入速度。refresh关掉能够极大的减少segments，也减少了merge，而去掉备份之后数据只需要写入一次。导入完成之后可以再把refresh和replica打开。值得一提的是，增加备份只是简单的数据传输，这个过程很快，但如果是向一个有备份的index写入数据，实际上在primary shard和replica上都需要进行索引，因此开销会大很多</p>
<p>但要注意，虽然这可以提升导入性能，但风险也提高了，因为导入过程中如果有节点挂掉，那么这个节点上的shards就不可用了，但如果是离线导入就还好，大不了重新导入就行</p>
<p><div class="note info"><h2>关闭swap</h2></div><br>稍微了解一下操作系统就知道swap对ES简直就是灾难，性能低还是其次，最重要的是会很容易把机器给爆掉，可以使用以下方法关闭swap<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1. 临时生效</span><br><span class="line">      swapoff -a</span><br><span class="line">2. 重启生效</span><br><span class="line">      vi /etc/sysctl.conf</span><br><span class="line">      添加或修改vm.swappiness = 0</span><br><span class="line">3. 在elasticsearch.yml中配置</span><br><span class="line">      bootstrap.memory_lock: true</span><br></pre></td></tr></table></figure></p>
<p><div class="note info"><h2>给pagecache预留memory</h2></div><br>官方说了，一半内存给ES，另外一半内存给lucene，也就是文件系统缓存。这很好理解，在缓存中的操作肯定比磁盘IO要快得多</p>
<p><div class="note info"><h2>使用自动分配的id</h2></div><br>如果你在index request中指定了id，那么ES会先去检查这个id是否存在，如果不存在，就新增一条记录，如果存在，则覆盖，检查id的动作是非常耗时的，特别是数据量特别大的情况下。如果index request中不指定id，ES会自动分配一个唯一的id，省去了id检查的过程，写入速度就得到提高</p>
<p>但如果你希望使用es的id来保证幂等性的话就没别的选择了，只能自己指定id</p>
<p><div class="note info"><h2>使用更好的硬件</h2></div><br>主要是磁盘，ES是重度依赖磁盘IO的软件</p>
<p>最好是SSD，这没什么好说的，就是快</p>
<p>然后是多块盘做raid0，由于数据是分散在多块盘上，所以如果一块盘坏掉可能会导致所有index不能用，但可以通过replica来规避风险</p>
<p><div class="note info"><h2>index buffer size</h2></div><br>如果你有重度写入需求，那么最好保证在一个节点上indices.memory.index_buffer_size / shards_count &gt; 512MB（超过这个值索引性能并不会有太明显提高）。indices.memory.index_buffer_size的默认值是10%，也就是说如果机器内存是64G，你把一半32G分配给了ES，那么buffer size为3.2G，能够支撑6.4个疯狂写入的shards</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kane-xie.github.io/2017/08/21/2017-08-21_系统可用性评判标准/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kane Xie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/attachment/hexo/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kane Xie">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/21/2017-08-21_系统可用性评判标准/" itemprop="url">系统可用性评判标准</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-21T00:00:00+08:00">
                2017-08-21
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/08/21/2017-08-21_系统可用性评判标准/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/08/21/2017-08-21_系统可用性评判标准/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/08/21/2017-08-21_系统可用性评判标准/" class="leancloud_visitors" data-flag-title="系统可用性评判标准">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="评判标准"><a href="#评判标准" class="headerlink" title="评判标准"></a>评判标准</h1><p><div class="note info"><h2>故障转移</h2></div><br>故障转移就是在某一个应用服务器不能服务用户请求的时候，通过一定的技术实现用户请求转移到其他应用服务器上来进行业务逻辑处理。例如使用nginx实现多个无状态实例的负载均衡，当其中一个或多个实例失效时，仍能通过其他实例提供服务</p>
<p><div class="note info"><h2>冗余备份</h2></div><br>冗余备份就是针对某一个服务通过服务器集群或多机房部署来达到服务器冗余和相互备份的目的。例如Kafka和HDFS的备份机制</p>
<p><div class="note info"><h2>超时设置</h2></div><br>超时设置就是主调服务在调用被调服务的时候设置一个超时等待时间Timeout，主调服务发现超时后，主动进入超时处理流程。超时设置的好处在于当某个服务不可用时，不至于整个系统发生连锁反应</p>
<p><div class="note info"><h2>异步调用</h2></div><br>采用异步调用的方式调用被调服务，有利于将主调服务和被调服务进行解耦，同时提高系统的处理性能</p>
<p><div class="note info"><h2>服务分级和降级</h2></div><br>对于不同的服务可以采用不同的处理方案，出现故障时应该优先保证核心服务的运行。</p>
<p><div class="note info"><h2>监控告警</h2></div><br>服务一旦出现问题能够及时发现，通过自动化处理，或者人工介入处理，从而达到缩短系统的不可用时间，提高可用性。常见的监控指标有：CPU、带宽、内存使用率、网络连接状态，系统调用错误，成功率，PV，UV等</p>
<p><div class="note info"><h2>防雪崩机制</h2></div><br>对于设计的任何一个系统，都需要进行容量的预估和最大容量设置，当外部请求量超过最大容量时，应该启动防雪崩机制，以避免大量外部请求把服务压跨而不能对外提供服务</p>
<p><div class="note info"><h2>流量缓冲机制</h2></div><br>在服务内可以建立队列，当流量过大时，储存一定的用户请求到队列，当流量偏小时再拿出来快速处理，从而达到削峰填谷的作用。例如在大数据存储中Kafka作为缓冲队列的应用</p>
<p><div class="note info"><h2>自动化测试</h2></div><br>对于每一次代码的提交，都能通过自动测试程序对整个服务进行整体的回归测试，这样可以快速地避免代码修改引入新的问题，而导致服务不稳定</p>
<h1 id="关键指标"><a href="#关键指标" class="headerlink" title="关键指标"></a>关键指标</h1><p><div class="note info"><h2>正常运行时间百分比</h2></div></p>
<table><thead><tr><th>描述</th><th>通俗叫法</th><th>可用百分比</th><th>年停机时间</th></tr></thead><tbody><tr><td>基本可用性</td><td>2个9</td><td>99%</td><td>87.6小时</td></tr><tr><td>较高可用性</td><td>3个9</td><td>99.9%</td><td>8.8小时</td></tr><tr><td>具有故障自动恢复能力的可用性</td><td>4个9</td><td>99.99%</td><td>53分钟</td></tr><tr><td>极高可用性</td><td>5个9</td><td>99.999%</td><td>5分钟</td></tr></tbody></table>

<p><div class="note info"><h2>容灾恢复能力</h2></div><br><code>RPO</code> 灾难过程中的最大数据丢失量<br><code>RTO</code> 系统从灾难状态恢复到可运行状态所需的时间</p>
<table><thead><tr><th>容灾等级</th><th>RTO</th><th>RPO</th></tr></thead><tbody><tr><td>第一级</td><td>&lt;2天</td><td>&lt;7天</td></tr><tr><td>第二级</td><td>&lt;24小时</td><td>&lt;7天</td></tr><tr><td>第三级</td><td>&lt;12小时</td><td>&lt;1天</td></tr><tr><td>第四级</td><td>&lt;2小时</td><td>&lt;1天</td></tr><tr><td>第五级</td><td>&lt;30分钟</td><td>&lt;30分钟</td></tr><tr><td>第六级</td><td>&lt;10分钟</td><td>0</td></tr></tbody></table>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kane-xie.github.io/2017/08/04/2017-08-04_Elasticsearch环境配置/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kane Xie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/attachment/hexo/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kane Xie">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/04/2017-08-04_Elasticsearch环境配置/" itemprop="url">Elasticsearch环境配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-04T00:00:00+08:00">
                2017-08-04
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/08/04/2017-08-04_Elasticsearch环境配置/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/08/04/2017-08-04_Elasticsearch环境配置/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/08/04/2017-08-04_Elasticsearch环境配置/" class="leancloud_visitors" data-flag-title="Elasticsearch环境配置">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><div class="note info"><h2>修改最大打开文件数，大于等于65536</h2></div></p>
<h3 id="临时生效"><a href="#临时生效" class="headerlink" title="临时生效"></a>临时生效</h3><blockquote>
<p>ulimit -n 65536</p>
</blockquote>
<h3 id="重启生效"><a href="#重启生效" class="headerlink" title="重启生效"></a>重启生效</h3><blockquote>
<p>vi /etc/security/limits.conf<br>@search         soft    nofile          65536<br>@search         hard    nofile          65536</p>
</blockquote>
<p><div class="note info"><h2>修改最大线程数，大于等于2048</h2></div></p>
<h3 id="临时生效-1"><a href="#临时生效-1" class="headerlink" title="临时生效"></a>临时生效</h3><blockquote>
<p>ulimit -u 2048</p>
</blockquote>
<h3 id="重启生效-1"><a href="#重启生效-1" class="headerlink" title="重启生效"></a>重启生效</h3><blockquote>
<p>vi /etc/security/limits.conf<br>@search         soft    nproc          2048<br>@search         hard    nproc          2048</p>
</blockquote>
<p><div class="note info"><h2>修改最大mmap数，大于等于262144</h2></div></p>
<h3 id="临时生效-2"><a href="#临时生效-2" class="headerlink" title="临时生效"></a>临时生效</h3><blockquote>
<p>sysctl -w vm.max_map_count=262144</p>
</blockquote>
<h3 id="重启生效-2"><a href="#重启生效-2" class="headerlink" title="重启生效"></a>重启生效</h3><blockquote>
<p>vi /etc/sysctl.conf<br>vm.max_map_count = 262144</p>
</blockquote>
<p><div class="note info"><h2>允许search用户锁住内存</h2></div></p>
<h3 id="临时生效-3"><a href="#临时生效-3" class="headerlink" title="临时生效"></a>临时生效</h3><blockquote>
<p>ulimit -l unlimited</p>
</blockquote>
<h3 id="重启生效-3"><a href="#重启生效-3" class="headerlink" title="重启生效"></a>重启生效</h3><blockquote>
<p>vi /etc/security/limits.conf<br>@search             soft        memlock unlimited<br>@search             hard    memlock unlimited</p>
</blockquote>
<p><div class="note info"><h2>禁用swap</h2></div></p>
<h3 id="临时生效-4"><a href="#临时生效-4" class="headerlink" title="临时生效"></a>临时生效</h3><blockquote>
<p>swapoff -a</p>
</blockquote>
<h3 id="重启生效-4"><a href="#重启生效-4" class="headerlink" title="重启生效"></a>重启生效</h3><blockquote>
<p>vi /etc/sysctl.conf<br>vm.swappiness = 0</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kane-xie.github.io/2017/07/25/2017-07-25_Kafka Streams State Store/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kane Xie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/attachment/hexo/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kane Xie">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/25/2017-07-25_Kafka Streams State Store/" itemprop="url">Kafka Streams State Store</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-25T00:00:00+08:00">
                2017-07-25
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/25/2017-07-25_Kafka Streams State Store/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/07/25/2017-07-25_Kafka Streams State Store/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/25/2017-07-25_Kafka Streams State Store/" class="leancloud_visitors" data-flag-title="Kafka Streams State Store">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Kafka Streams默认使用RocksDB来存储状态</p>
<div class="note info"><h2>In-memory or persistent ?</h2></div>

<p>状态可配置为保存在内存中或者持久化，RocksDB对于两者都适用，并且可以通过Stores factory API在两者间切换。StateStoreSupplier被创建之后，可以用于Kafka Streams DSL API（high level），也可以用于Processor API（low level）</p>
<div class="note info"><h2>持久化</h2></div>

<p>为了保存状态，RocksDB会把state store的内容flush到StreamsConfig.STATE_DIR_CONFIG指定的磁盘上</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config.put(StreamsConfig.STATE_DIR_CONFIG, <span class="string">"my-state-store"</span>)</span><br></pre></td></tr></table></figure>
<div class="note info"><h2>Changelog</h2></div>

<p>出于灾备和扩展性的考虑，state store的内容同样会默认保存changelog到kafka的topic中，topic名字为<code>&lt;application_id&gt;-&lt;state_store_name&gt;-changelog</code>，你可以通过enableLogging和disableLogging来开启或关闭该功能</p>
<p>如果task由于异常或宕机造成中断，在原来的机器或另一台机器重启之后，Kafka Streams能够优先通过重放changelog恢复state store的内容，而不是在新的task中创建新的state store，这是Kafka Streams状态安全性的保证</p>
<p>如果在task运行过程中删除changelog对应的topic，Kafka Streams会在下一个checkpoint再次写入changelog，但如果在下个checkpoint之前task中断，state store的数据将无法恢复</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/attachment/hexo/avatar.jpg" alt="Kane Xie">
            
              <p class="site-author-name" itemprop="name">Kane Xie</p>
              <p class="site-description motion-element" itemprop="description">不吃早餐才是一件很嘻哈的事</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">72</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">28</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/kane-xie" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:kane.xiejing@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kane Xie</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"your-duoshuo-shortname"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  


















  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("LPm366LbupmURAm4bXbbAvWn-gzGzoHsz", "pSom1u6E7p0p2dKydvdTMaI2");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
